<script>
  // ===== DATOS FIJOS / BASE =====
  const BASE_MONDAY_DMY = "20/10/2025"; // semana base (lunes)
  const TURNOS = [
    { titulo:"Turno 1 - Mañana (Full)", horario:"7:00 a.m. - 3:00 p.m." },
    { titulo:"Turno 2 - Noche",         horario:"11:00 p.m. - 7:00 a.m." },
    { titulo:"Turno 3 - Tarde (Full)",  horario:"3:00 p.m. - 11:00 p.m." },
    { titulo:"Turno 4 - Agregado",      horario:"8:00 a.m. - 5:00 p.m." }
  ];
  // Semana base (20/10/2025): T1=Marisol, T2=Gualberto, T3=Humberto, T4=Edgar
  const PEOPLE_BASE = ["Marisol Caldera","Gualberto Rodriguez","Humberto Castillo","Edgar Pérez"];

  // ===== PERSISTENCIA (para personalizar nombres/horarios en el dispositivo) =====
  const Store = {
    load(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };
  let customPeople = Store.load("rolPeople", PEOPLE_BASE.slice());
  const turnosDef = Store.load("rolTurnosDef", TURNOS.map(t=>({...t})));

  // ===== FECHAS (DST-safe para calcular semanas) =====
  function parseDMY(s){ const [d,m,y]=s.trim().split(/[\/\-]/).map(n=>parseInt(n,10)); return new Date(y,m-1,d); }
  const fmtDMY = d => d.toLocaleDateString("es-MX",{day:"2-digit",month:"2-digit",year:"numeric"});
  const isoForInput = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);

  const asUTC = d => new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayIndexUTC = d => Math.floor(asUTC(d).getTime()/86400000);
  const mondayIndexUTC = d => { const u=asUTC(d); const dow=(u.getUTCDay()+6)%7; return dayIndexUTC(d)-dow; };

  // Para mostrar el LUNES en horario local (evita ver “domingo”)
  function mondayLocalOf(date){
    const dt = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const dow = (dt.getDay()+6)%7; // lunes=0
    dt.setDate(dt.getDate()-dow);
    return dt;
  }

  // rotación
  const rotateRight = (arr,n)=>{ const a=arr.slice(); const k=((n%a.length)+a.length)%a.length; return k? a.slice(-k).concat(a.slice(0,-k)) : a; };

  // semanas transcurridas desde la base (entero)
  const BASE_IDX = mondayIndexUTC(parseDMY(BASE_MONDAY_DMY));
  function weeksSinceBase(date){ return mondayIndexUTC(date) - BASE_IDX; }

  // ===== UI refs =====
  const $fecha=document.getElementById("fecha");
  const $btn=document.getElementById("btnConsultar");
  const $enc=document.getElementById("encabezado");
  const $grid=document.getElementById("gridTurnos");

  const $btnToggleCfg=document.getElementById("btnToggleCfg");
  const $cfg=document.getElementById("configPanel");
  const $t1Nombre=document.getElementById("t1Nombre"), $t1Horario=document.getElementById("t1Horario");
  const $t2Nombre=document.getElementById("t2Nombre"), $t2Horario=document.getElementById("t2Horario");
  const $t3Nombre=document.getElementById("t3Nombre"), $t3Horario=document.getElementById("t3Horario");
  const $t4Nombre=document.getElementById("t4Nombre"), $t4Horario=document.getElementById("t4Horario");
  const $btnGuardar=document.getElementById("btnGuardar"), $btnReset=document.getElementById("btnReset");

  $fecha.value = isoForInput(new Date());

  function render(fecha){
    const w = weeksSinceBase(fecha);             // semanas desde la base
    const mondayLocal = mondayLocalOf(fecha);    // lunes en horario local
    // *** AJUSTE CLAVE: rotamos con -w para que 27/10/2025 dé (Edgar, Marisol, Gualberto, Humberto) ***
    const peopleRotated = rotateRight(customPeople, -w);

    $enc.textContent = `🗓 Fecha: ${fmtDMY(fecha)} — 📅 Semana iniciada el: ${fmtDMY(mondayLocal)}`;
    $grid.innerHTML = "";
    for (let i=0;i<4;i++){
      const t = turnosDef[i];
      const p = peopleRotated[i];
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="title">${t.titulo}</div>
        <div><strong>Horario:</strong> ${t.horario}</div>
        <div><strong>Nombre:</strong> ${p}</div>
      `;
      $grid.appendChild(card);
    }
  }

  $btn.addEventListener("click", ()=>{
    const d = $fecha.value ? new Date($fecha.value+"T12:00:00") : new Date();
    render(d);
  });

  // Panel de personalización (opcional)
  $btnToggleCfg.addEventListener("click", ()=>{
    const show = $cfg.style.display!=="block";
    $cfg.style.display = show ? "block" : "none";
    if (show){
      [$t1Nombre,$t2Nombre,$t3Nombre,$t4Nombre].forEach((i,idx)=> i.value = customPeople[idx]);
      [$t1Horario,$t2Horario,$t3Horario,$t4Horario].forEach((i,idx)=> i.value = turnosDef[idx].horario);
    }
  });

  $btnGuardar.addEventListener("click", ()=>{
    customPeople[0] = $t1Nombre.value || customPeople[0];
    customPeople[1] = $t2Nombre.value || customPeople[1];
    customPeople[2] = $t3Nombre.value || customPeople[2];
    customPeople[3] = $t4Nombre.value || customPeople[3];
    turnosDef[0].horario = $t1Horario.value || turnosDef[0].horario;
    turnosDef[1].horario = $t2Horario.value || turnosDef[1].horario;
    turnosDef[2].horario = $t3Horario.value || turnosDef[2].horario;
    turnosDef[3].horario = $t4Horario.value || turnosDef[3].horario;
    Store.save("rolPeople", customPeople);
    Store.save("rolTurnosDef", turnosDef);
    alert("Cambios guardados ✅");
    const d = $fecha.value ? new Date($fecha.value+"T12:00:00") : new Date();
    render(d);
  });

  $btnReset.addEventListener("click", ()=>{
    if (!confirm("¿Restablecer valores por defecto?")) return;
    customPeople = PEOPLE_BASE.slice();
    for(let i=0;i<4;i++){ turnosDef[i].horario = TURNOS[i].horario; turnosDef[i].titulo = TURNOS[i].titulo; }
    Store.save("rolPeople", customPeople);
    Store.save("rolTurnosDef", turnosDef);
    const d = $fecha.value ? new Date($fecha.value+"T12:00:00") : new Date();
    render(d);
    alert("Listo");
  });

  // Primer render
  render(new Date());

  // (opcional) registra el SW si existe
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js'));
  }
</script>
