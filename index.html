<script>
  // ===================== Persistencia =====================
  const Store = {
    load(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
    save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ===================== Turnos fijos =====================
  const shifts = [
    { id:1, name:"Turno 1 - MaÃ±ana",  schedule:"7:00 a.m. - 3:00 p.m." },
    { id:2, name:"Turno 2 - Noche",   schedule:"11:00 p.m. - 7:00 a.m." },
    { id:3, name:"Turno 3 - Tarde",   schedule:"3:00 p.m. - 11:00 p.m." },
    { id:4, name:"Turno 4 - Interna", schedule:"8:00 a.m. - 5:00 p.m." }
  ];

  // ===================== Config compartida =====================
  let settings = Store.load("settingsSimple", {
    startMonday: "20/10/2025", // ahora en formato DD/MM/YYYY
    baseShift: 1,
    cycleWeeks: 4
  });

  // ===================== Utilidades =====================
  function parseDMY(s){
    if (!s) return null;
    const [d,m,y] = s.trim().split(/[\/\-]/).map(n=>parseInt(n,10));
    if (!y || !m || !d) return null;
    return new Date(y, m-1, d);
  }
  function formatDMY(d){
    return d.toLocaleDateString("es-MX",{day:"2-digit",month:"2-digit",year:"numeric"});
  }

  function toMonday(d){
    const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (dt.getDay()+6)%7;
    dt.setDate(dt.getDate()-day);
    return dt;
  }

  function weeksSinceBase(date){
    const monday = toMonday(date);
    const base = toMonday(parseDMY(settings.startMonday));
    const diffDays = Math.floor((asUTCDate(monday) - asUTCDate(base)) / (7*24*3600*1000));
    return diffDays;
  }

  function asUTCDate(d){ return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); }

  function formatYYYYMMDD(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  function getDateValue(input){ return input.value ? new Date(input.value + "T12:00:00") : new Date(); }

  // ===================== CÃ¡lculo =====================
  function getShiftForDate(targetDate){
    const monday = toMonday(targetDate);
    const w = weeksSinceBase(targetDate);
    const n = ((settings.baseShift - 1 + w) % 4 + 4) % 4;
    const shiftId = n + 1;
    const shift = shifts.find(s => s.id === shiftId);
    return { shift, monday };
  }

  // ===================== UI =====================
  const $fecha = document.getElementById("fecha");
  const $btnConsultar = document.getElementById("btnConsultar");
  const $lblFecha = document.getElementById("lblFecha");
  const $lblSemana = document.getElementById("lblSemana");
  const $lblTurno = document.getElementById("lblTurno");
  const $lblHorario = document.getElementById("lblHorario");
  const $lblNota = document.getElementById("lblNota");
  const $btnToggleCfg = document.getElementById("btnToggleCfg");
  const $configPanel = document.getElementById("configPanel");
  const $btnConfigurar = document.getElementById("btnConfigurar");
  const $btnReset = document.getElementById("btnReset");

  $fecha.value = formatYYYYMMDD(new Date());

  function mostrarResultado(fecha){
    const {shift, monday} = getShiftForDate(fecha);
    $lblFecha.textContent = `ðŸ—“ Fecha: ${formatDMY(fecha)}`;
    $lblSemana.textContent = `ðŸ“… Semana iniciada el: ${formatDMY(monday)}`;
    $lblTurno.textContent = `Te toca: ${shift.name}`;
    $lblHorario.textContent = `ðŸ•’ Horario: ${shift.schedule}`;
  }

  $btnConsultar.addEventListener("click", ()=> mostrarResultado(getDateValue($fecha)));

  $btnToggleCfg.addEventListener("click", ()=>{
    $configPanel.style.display = $configPanel.style.display === "block" ? "none" : "block";
  });

  $btnConfigurar.addEventListener("click", ()=>{
    const baseRaw = prompt("Ingresa el LUNES base (DD/MM/YYYY):", settings.startMonday || "20/10/2025");
    if (!baseRaw) return;
    const baseDate = parseDMY(baseRaw);
    if (!baseDate) { alert("Formato invÃ¡lido. Usa DD/MM/YYYY."); return; }
    const baseMonday = toMonday(baseDate);
    const baseStr = formatDMY(baseMonday);

    const turnoStr = prompt(
      "Â¿En quÃ© turno estÃ¡s actualmente (1..4)?\n1. Turno 1 â€“ MaÃ±ana\n2. Turno 2 â€“ Noche\n3. Turno 3 â€“ Tarde\n4. Turno 4 â€“ Interna",
      settings.baseShift || 1
    );
    const turno = parseInt(turnoStr);
    if (![1,2,3,4].includes(turno)) { alert("Valor invÃ¡lido."); return; }

    settings.startMonday = baseStr;
    settings.baseShift = turno;
    Store.save("settingsSimple", settings);
    alert(`ConfiguraciÃ³n guardada âœ…\n\nLunes base: ${baseStr}\nTurno actual: ${turno}`);
    mostrarResultado(getDateValue($fecha));
  });

  $btnReset.addEventListener("click", ()=>{
    if (!confirm("Â¿Restablecer configuraciÃ³n?")) return;
    settings = { startMonday:"20/10/2025", baseShift:1, cycleWeeks:4 };
    Store.save("settingsSimple", settings);
    mostrarResultado(getDateValue($fecha));
    alert("Hecho");
  });

  mostrarResultado(new Date());

  if ("serviceWorker" in navigator) {
    window.addEventListener("load", ()=> navigator.serviceWorker.register("sw.js"));
  }
</script>
