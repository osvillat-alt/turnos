<script>
  // ===================== Persistencia =====================
  const Store = {
    load(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
    save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ===================== Turnos fijos =====================
  const shifts = [
    { id:1, name:"Turno 1 - MaÃ±ana",  schedule:"7:00 a.m. - 3:00 p.m." },
    { id:2, name:"Turno 2 - Noche",   schedule:"11:00 p.m. - 7:00 a.m." },
    { id:3, name:"Turno 3 - Tarde",   schedule:"3:00 p.m. - 11:00 p.m." },
    { id:4, name:"Turno 4 - Interna", schedule:"8:00 a.m. - 5:00 p.m." }
  ];

  // ===================== ConfiguraciÃ³n mÃ­nima compartida =====================
  // startMonday: LUNES base (YYYY-MM-DD)
  // baseShift:   turno activo esa semana (1..4)
  // cycleWeeks:  fijo en 4
  let settings = Store.load("settingsSimple", {
    startMonday: "2025-10-20",
    baseShift: 1,
    cycleWeeks: 4
  });

  // ===================== Utilidades de fecha (con normalizaciÃ³n) =====================
  // Acepta 'YYYY-MM-DD' o 'YYYY/MM/DD' y crea Date en zona local sin ambigÃ¼edad
  function parseYmd(s) {
    if (!s) return null;
    const parts = s.trim().replace(/\//g, "-").split("-");
    if (parts.length !== 3) return null;
    const [y, m, d] = parts.map(n => parseInt(n, 10));
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d); // Fecha local
  }

  // Lunes de la semana de una fecha (local)
  function toMonday(d) {
    const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (dt.getDay() + 6) % 7; // lunes=0
    dt.setDate(dt.getDate() - day);
    return dt;
  }

  // YYYY-MM-DD en zona local
  function formatYYYYMMDD(d) {
    return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }
  function setDateValue(input, date){ input.value = formatYYYYMMDD(date); }
  function getDateValue(input){ return input.value ? new Date(input.value + "T12:00:00") : new Date(); }

  // Semanas transcurridas (enteras) entre el lunes de la fecha y el lunes base
  function weeksSinceBase(date){
    const monday = toMonday(date);
    const base   = toMonday(parseYmd(settings.startMonday));
    const msWeek = 7*24*3600*1000;
    return Math.floor((monday - base) / msWeek);
  }

  // ===================== CÃ¡lculo del turno =====================
  function getShiftForDate(targetDate){
    const monday = toMonday(targetDate);
    const w = weeksSinceBase(targetDate);
    // turno = baseShift + semanasTranscurridas (mod 4), en [1..4]
    const n = ((settings.baseShift - 1 + w) % 4 + 4) % 4;
    const shiftId = n + 1;
    const shift = shifts.find(s => s.id === shiftId);
    return { shift, monday };
  }

  // ===================== UI refs =====================
  const $fecha        = document.getElementById("fecha");
  const $btnConsultar = document.getElementById("btnConsultar");
  const $lblFecha     = document.getElementById("lblFecha");
  const $lblSemana    = document.getElementById("lblSemana");
  const $lblTurno     = document.getElementById("lblTurno");
  const $lblHorario   = document.getElementById("lblHorario");
  const $lblNota      = document.getElementById("lblNota");
  const $btnToggleCfg = document.getElementById("btnToggleCfg");
  const $configPanel  = document.getElementById("configPanel");
  const $btnConfigurar= document.getElementById("btnConfigurar");
  const $btnReset     = document.getElementById("btnReset");

  // Fecha por defecto = hoy
  setDateValue($fecha, new Date());

  // Formato amigable
  const fmt = (d)=> d.toLocaleDateString("es-MX",{day:"2-digit",month:"2-digit",year:"numeric"});

  function mostrarResultado(fecha){
    const {shift, monday} = getShiftForDate(fecha);
    $lblFecha.textContent   = `ðŸ—“ Fecha: ${fmt(fecha)}`;
    $lblSemana.textContent  = `ðŸ“… Semana iniciada el: ${fmt(monday)}`;
    $lblTurno.textContent   = `Te toca: ${shift.name}`;
    $lblHorario.textContent = `ðŸ•’ Horario: ${shift.schedule}`;
    $lblNota.textContent    = "";
  }

  // ===================== Eventos =====================
  $btnConsultar.addEventListener("click", ()=> mostrarResultado(getDateValue($fecha)));

  $btnToggleCfg.addEventListener("click", ()=>{
    const show = $configPanel.style.display !== "block";
    $configPanel.style.display = show ? "block" : "none";
  });

  // Configurar ciclo (SOLO lunes base y turno actual)
  $btnConfigurar.addEventListener("click", ()=>{
    const baseRaw = prompt("Ingresa el LUNES base (YYYY-MM-DD):", settings.startMonday || "2025-10-20");
    if (!baseRaw) return;

    const baseDt = parseYmd(baseRaw);
    if (!baseDt || isNaN(baseDt)) { alert("Fecha invÃ¡lida. Usa formato YYYY-MM-DD."); return; }

    // Normalizamos para guardar exactamente el LUNES de esa semana
    const baseMonday = toMonday(baseDt);
    const baseStr    = formatYYYYMMDD(baseMonday);

    const turnoBaseStr = prompt(
      "Â¿En quÃ© turno estÃ¡s actualmente (en la semana del LUNES base)? (1..4)\n" +
      "1. Turno 1 â€“ MaÃ±ana\n" +
      "2. Turno 2 â€“ Noche\n" +
      "3. Turno 3 â€“ Tarde\n" +
      "4. Turno 4 â€“ Interna",
      String(settings.baseShift || 1)
    );
    const turnoBase = parseInt(turnoBaseStr, 10);
    if (![1,2,3,4].includes(turnoBase)) { alert("Valor de turno invÃ¡lido."); return; }

    settings.startMonday = baseStr;   // guardamos el LUNES exacto
    settings.baseShift   = turnoBase; // turno activo esa semana
    settings.cycleWeeks  = 4;         // fijo
    Store.save("settingsSimple", settings);

    alert(
      "ConfiguraciÃ³n guardada âœ…\n\n" +
      `Lunes base: ${settings.startMonday}\n` +
      `Turno actual (SEMANA BASE): ${turnoBase}\n` +
      `Ciclo: 4 semanas`
    );

    mostrarResultado(getDateValue($fecha));
  });

  $btnReset.addEventListener("click", ()=>{
    if (!confirm("Â¿Restablecer a valores por defecto?")) return;
    settings = { startMonday:"2025-10-20", baseShift:1, cycleWeeks:4 };
    Store.save("settingsSimple", settings);
    mostrarResultado(getDateValue($fecha));
    alert("Hecho");
  });

  // Primer render
  mostrarResultado(new Date());

  // Por si algÃºn HTML viejo aÃºn trae el botÃ³n "Editar patrÃ³n", lo removemos a la fuerza:
  document.getElementById('btnEditarPatron')?.remove();
  [...document.querySelectorAll('button')].forEach(b=>{
    const t=(b.textContent||"").trim().toLowerCase();
    if (t==="editar patrÃ³n" || t==="editar patron") b.remove();
  });

  // Registrar Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", ()=> navigator.serviceWorker.register("sw.js"));
  }
</script>
